(function(e){e.widget("the.canvas",e.ui.mouse,{options:e.extend({},e.ui.mouse.options,{appendTo:"body",distance:0}),_init:function(){this._mouseInit();this.canvas=document.getElementById(this.element[0].id);this.isPainting=true;this.isOffCanvas=false;this.dragOffset=null;this.points=[];this.pointsSinceLineWeightCheck=0;this.defaultLineWidth=3;this.ease=.7;var t=this;window.scrolled=false;e(window).bind("scroll resize",function(){window.scrolled=true})},destroy:function(){this._mouseDestroy()},_mouseStart:function(t){t.preventDefault();this.context=this.canvas.getContext("2d");if(this.context){if(this.dragOffset===null){this.dragOffset=e(t.target).offset()}this.context.fillStyle="rgba(200, 200, 200, 0.3)";this.context.lineCap="round";this.context.lineWidth=this.defaultLineWidth;this.isPainting=true;this.isOffCanvas=false;this.duration=+(new Date);var n=t.pageX-this.dragOffset.left;var r=t.pageY-this.dragOffset.top;if(t.pageX==0&&t.originalEvent&&t.originalEvent.touches){n=t.originalEvent.touches[0].pageX-this.dragOffset.left;r=t.originalEvent.touches[0].pageY-this.dragOffset.top}this.points.push({x:n,y:r})}},_mouseDrag:function(t){this.isDragging=true;if(this.context&&this.isPainting&&!this.isOffCanvas){if(this.dragOffset===null||window.scrolled){if(window.scrolled){this.lastDragOffset=this.dragOffset}this.dragOffset=e(t.target).offset();window.scrolled=false}var n=t.pageX-this.dragOffset.left;var r=t.pageY-this.dragOffset.top;if(t.pageX==0&&t.originalEvent&&t.originalEvent.touches){n=t.originalEvent.touches[0].pageX-this.dragOffset.left;r=t.originalEvent.touches[0].pageY-this.dragOffset.top}this.points.push({x:n,y:r});this.pointsSinceLineWeightCheck++;this.drawCurvyLine()}},_mouseStop:function(e){this.duration=+(new Date)-this.duration;if(this.isDragging){this.drawLine()}else{this.drawPoint()}this.pointsSinceLineWeightCheck=0;this.context.lineWidth=this.defaultLineWidth;this.isPainting=false;this.isDragging=false;this.isOffCanvas=false;this.canvas.blur();this.context.save()},lineWeightCheck:function(){var e=this.points,t=e.length-1,n=0,r=0;if(t>0){n=Math.sqrt(Math.pow(e[t].x-e[t-1].x,2)+Math.pow(e[t-1].y-e[t-1].y,2));if(n<1){r=5}else{if(n<3){r=4}else{if(n<15){r=3}else{if(n<20){r=2}else{r=1}}}}if(n<10&&this.pointsSinceLineWeightCheck>10||n>10&&this.pointsSinceLineWeightCheck>5){if(r>this.context.lineWidth){this.context.lineWidth++}else{if(r<this.context.lineWidth){this.context.lineWidth--}}this.pointsSinceLineWeightCheck=0}}},drawPoint:function(){var e=this.points,t=this.context,n=1;if(e.length==1){if(this.duration>1e3){n=6}else{if(this.duration>600){n=5}else{if(this.duration>320){n=4}else{if(this.duration>220){n=3}else{if(this.duration>120){n=2}else{n=1}}}}}t.beginPath();t.arc(e[0].x,e[0].y,n,0,2*Math.PI,true);t.fillStyle="#000000";t.fill()}this.points=[]},drawLine:function(){var e=this.points,t=0;this.context.beginPath();this.context.moveTo(e[0].x,e[0].y);for(t=1;t<e.length;t++){this.context.lineTo(e[t].x,e[t].y);this.context.stroke();this.context.moveTo(e[t].x,e[t].y)}this.points=[]},drawCurvyLine:function(){var e=this.context,t=this.points,n=0,r=3,i=0,s=0;if(t.length<r){return}this.lineWeightCheck();e.beginPath();e.moveTo(t[0].x,t[0].y);for(n=0;n<t.length-1;n++){t[n+1].x=t[n].x+(t[n+1].x-t[n].x)*this.ease;t[n+1].y=t[n].y+(t[n+1].y-t[n].y)*this.ease;i=(t[n].x+t[n+1].x)/2;s=(t[n].y+t[n+1].y)/2;e.quadraticCurveTo(t[n].x,t[n].y,i,s)}e.stroke();this.points=[{x:i,y:s},t.pop()]},clearCanvas:function(){this.context=this.canvas.getContext("2d");this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}})})(jQuery)